<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Time-Lapse Wireless Image Access</title>
    <style>
      body {
        background-image: linear-gradient(90deg, rgb(5, 175, 5), rgb(32, 97, 255));
        text-align: center;
      }
      h1 {
        font-family: sans-serif;
        font-weight: 700;
        color: yellow;
        background-color: #0003;
        padding: 7px;
        border-radius: 12px;
      }
      label {
        font-family: fantasy;
        color: white;
      }
      input, button {
        font-family: monospace;
        color: yellow;
        background-image: linear-gradient(cyan, cornflowerblue);
        text-align: center;
        padding: 7px;
        border-radius: 20px;
        border-color: rgb(82, 177, 255);
        border-style: solid;
        border-width: 3px;
      }
      input:hover, button:hover {
        cursor: pointer;
      }
      img {
        border-radius: 12px;
        width: 100%;
      }
    </style>
    <script>

      var months = ["", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      var vid = [];
      
      function imgname(timeInput) {
        return "./" + months[parseInt(timeInput.slice(5,7))] + "_" + timeInput.slice(8,10) + "_" + timeInput.slice(0,4) + "_" + timeInput.slice(11,13) + ":" + timeInput.slice(14,16) + ".jpg";
      }

      function $(elementID) {
        return document.getElementById(elementID);
      }

      function img64(Url, Then = function(base64img){}, Err = function(statusCode){}) {
        var x = new XMLHttpRequest();
        x.open("GET", Url);
        x.responseType = "blob";
        x.send();
        x.onload = function() {
          if (this.status != 200) {
            Err(this.status);
          } else {
            var reader = new FileReader();
            reader.readAsDataURL(x.response); 
            reader.onloadend = function() {
              Then(reader.result);
            };
          }
        };
      }
      
      function getImg() {
        var input = $("single-input").value;
        $("img").src = imgname(input);
      }

      function digits2(n) {
        if (n < 10) {
          return "0" + n.toString();
        } else {
          return n.toString();
        }
      }

      function progress1() {
        $("loading").value += 1;
        if ($("loading").value >= $("loading").max) {
          $("progressbar").display = 'none';
        }
      }

      function getVid() {
        var startHour = parseInt($("startTime").value.slice(0,2));
        var startMin = parseInt($("startTime").value.slice(3,5));
        var endHour = parseInt($("endTime").value.slice(0,2));
        var endMin = parseInt($("endTime").value.slice(3,5));
        var pics = 60*(endHour - startHour) + (endMin - startMin);
        $("loading").value = 0;
        $("loading").max = pics + 1;
        $("progressbar").display = '';
        vid = [];
        var hour = startHour;
        var min = startMin;
        for (i=0; i<=pics; i++) {
          vid[i] = imgname($("timelapse-day").value + "T" + digits2(hour) + ":" + digits2(min));
          eval("img64(vid[i],function(data){vid["+i.toString()+"]=data;progress1()},function(){vid["+i.toString()+"]='';progress1()})");
          min++;
          if (min >= 60) {
            min -= 60;
            hour++;
          }
        }
      }

      var vidIndex = 0;
      var playing = -1;
      var fps = 5;

      function back() {
        vidIndex--;
        if (vid[vidIndex].length > 0) {
          $("img").src = vid[vidIndex];
        }
        if (vidIndex < 0) {
          vidIndex = 0;
        }
      }

      function next() {
        vidIndex++;
        if (vid[vidIndex].length > 0) {
          $("img").src = vid[vidIndex];
        }
        if (vidIndex >= vid.length) {
          vidIndex = vid.length - 1;
        }
      }

      function playpause() {
        if (playing == 0) { // Play
          playing = setInterval(function() {next()}, 1000/fps);
        } else {
          clearInterval(playing);
          playing = 0;
        }
      }

    </script>
  </head>
  <body>
    <h1>Time-Lapse Wireless Access</h1>
    <section>
      <h2>Retrieve Single Image</h2>
      <input type="datetime-local" id="single-input"><br>
      <button onclick="getImg()">Load Image</button>
    </section>
    <section>
      <h2>Retrieve Timelapse</h2>
      <input type="date" id="timelapse-day"><br>
      <label for="startTime">From</label>
      <input type="time" id="startTime">
      <label for="endTime">to</label>
      <input type="time" id="endTime"><br>
      <button onclick="getVid()">Load Timelapse</button>
    </section>
    <br><br>
    <img id="img" src="./live.jpg"/>
    <br><br>
    <section id="timelapseCTRL">
      <button onclick="back()">⏮️</button>
      <button onclick="next()">⏭️</button>
      <button onclick="playpause()">⏯️</button>
    </section>
    <section id="progressbar">
      <label id="loadingLabel" for="loading">Loading Timelapse....</label>
      <progress id="loading" max="120" val="0"></progress>
    </section>
  </body>
</html>
